<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ASCII live · app</title>

  <link rel="stylesheet" href="styles.css?v=24" />
  <script src="consent.js" defer></script>
</head>
<body class="theme-dark">

  <!-- Модалка согласия -->
  <div class="modal" id="consent" hidden>
    <div class="card">
      <h3>Доступ к камере</h3>
      <p>Видеопоток обрабатывается локально на вашем устройстве, без отправки на сервер.</p>
      <div class="actions">
        <button id="agree" class="btn">Ок, понимаю</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="toolbar">
      <button id="flip" class="btn">Фронт/Тыл</button>
      <button id="toggle" class="btn">Настройки</button>
    </div>

    <!-- Настройки (скрыты при старте) -->
    <div class="panel" id="settings" hidden>
      <label>
        <span>Ширина</span>
        <input id="w" type="range" min="40" max="320" step="1" value="160" />
        <output id="w_out">160</output>
      </label>

      <label>
        <span>Контраст</span>
        <input id="c" type="range" min="0.50" max="3.00" step="0.01" value="1.15" />
        <output id="c_out">1.15</output>
      </label>

      <label>
        <span>Гамма</span>
        <input id="g" type="range" min="0.50" max="3.00" step="0.01" value="1.20" />
        <output id="g_out">1.20</output>
      </label>

      <label>
        <span>Цвет</span>
        <input id="fg" type="color" value="#8ac7ff" />
      </label>

      <label>
        <span>Фон</span>
        <input id="bg" type="color" value="#000000" />
      </label>

      <label>
        <span>FPS</span>
        <input id="fps" type="range" min="5" max="60" step="1" value="30" />
        <output id="fps_out">30</output>
      </label>

      <label>
        <span>Набор</span>
        <select id="ramp">
          <option value=" .'`&quot;,:;Il!i~+_-?][}{1tfjrxnuvczXYUJCLQ0089@#">Классический</option>
          <option value=" .,:;!|iI1l">Тонкая линия</option>
          <option value=" 0123456789">Цифры</option>
          <option value="  abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ">Буквы</option>
          <option value=" .·:•*oO@#">Точки</option>
        </select>
      </label>

      <label class="check">
        <input id="inv" type="checkbox" checked />
        <span>Инверсия</span>
      </label>
    </div>

    <div class="stage">
      <pre id="out"></pre>
    </div>
  </div>

  <script type="module">
    import { AsciiApp } from './ascii.js';
    const $ = id => document.getElementById(id);

    const ui = {
      out: $('out'),
      flip: $('flip'),
      toggle: $('toggle'),
      settings: $('settings'),

      w: $('w'), c: $('c'), g: $('g'),
      fg: $('fg'), bg: $('bg'),
      fps: $('fps'),
      ramp: $('ramp'),
      inv: $('inv'),

      w_out: $('w_out'), c_out: $('c_out'), g_out: $('g_out'), fps_out: $('fps_out'),
    };

    const app = new AsciiApp(ui.out);

    // применяем опции в движок
    function apply(changed = {}) {
      ui.w_out.textContent   = ui.w.value;
      ui.c_out.textContent   = Number(ui.c.value).toFixed(2);
      ui.g_out.textContent   = Number(ui.g.value).toFixed(2);
      ui.fps_out.textContent = ui.fps.value;

      app.setOptions({
        widthChars: +ui.w.value,
        contrast:   +ui.c.value,
        gamma:      +ui.g.value,
        color:       ui.fg.value,
        background:  ui.bg.value,
        fps:        +ui.fps.value,
        ramp:        ui.ramp.value,
        invert:      ui.inv.checked
      });

      // РЕФИТ только если меняли ширину или набор
      if (changed.w || changed.ramp) app.refit();
    }

    // события
    ui.w.addEventListener('input',  () => apply({ w:true }));
    ui.ramp.addEventListener('change', () => apply({ ramp:true }));

    ['c','g','fg','bg','fps','inv'].forEach(id=>{
      const el = $(id);
      el.addEventListener('input',  () => apply({}));
      el.addEventListener('change', () => apply({}));
    });

    ui.toggle.addEventListener('click', () => {
      const hidden = ui.settings.hasAttribute('hidden');
      if (hidden) {
        ui.settings.removeAttribute('hidden');
        localStorage.setItem('ui-settings-open', '1');
      } else {
        ui.settings.setAttribute('hidden','');
        localStorage.setItem('ui-settings-open', '0');
      }
    });

    // восстановить состояние панели
    if (localStorage.getItem('ui-settings-open') === '1') ui.settings.removeAttribute('hidden');

    ui.flip.addEventListener('click', async () => {
      await app.flip();
      app.refit();
    });

    // старт после согласия
    document.addEventListener('consent-ready', async () => {
      await app.start();
      app.refit();
      apply({});
    });

    // если согласие уже было
    try{
      if(localStorage.getItem('consent-ok') === '1'){
        await app.start();
        app.refit();
        apply({});
      }
    }catch(e){}
  </script>
</body>
</html>
