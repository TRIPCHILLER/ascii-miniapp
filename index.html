<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ASCII live · app</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="theme-dark">
  <div class="wrap">
    <div class="toolbar">
      <button id="start" class="btn">Начать</button>
      <button id="stop"  class="btn" disabled>Стоп</button>
      <button id="flip"  class="btn">Фронт/Тыл</button>
      <button id="fs"    class="btn ghost">Fullscreen</button>
      <a class="btn ghost" href="pro.html">Настройки</a>
    </div>
    <div class="stage"><pre id="out"></pre></div>
  </div>

  <!-- Дисклеймер (скрыт по умолчанию — покажем его только на первом запуске) -->
  <div id="consent" class="modal" hidden>
    <div class="card" role="dialog" aria-modal="true">
      <h3>Доступ к камере</h3>
      <p>Видеопоток обрабатывается локально, без отправки на сервер.</p>
      <p><a href="privacy.html" target="_blank" rel="noopener">Подробнее</a></p>
      <!-- Инлайновый обработчик: работает даже если модуль не загрузился -->
      <button id="agree" class="btn" type="button"
        onclick="
          try {
            localStorage.setItem('consent-ok','1');
            var m = document.getElementById('consent');
            if (m) m.setAttribute('hidden','');
          } catch(e) {}
          return false;
        ">OK</button>
    </div>
  </div>

  <!-- Мини-скрипт, НЕ модуль: сам показывает дисклеймер на ПЕРВОМ запуске -->
  <script>
    (function () {
      try {
        if (localStorage.getItem('consent-ok') !== '1') {
          var m = document.getElementById('consent');
          if (m) m.hidden = false;
        }
      } catch (e) {
        var m = document.getElementById('consent');
        if (m) m.hidden = false;
      }
    })();
  </script>

  <!-- Основное приложение (module). Если оно не загрузится — кнопка OK всё равно сработает. -->
  <script type="module">
    import { AsciiApp, wireFullscreen } from './ascii.js';

    const ui = {
      start:   document.getElementById('start'),
      stop:    document.getElementById('stop'),
      flip:    document.getElementById('flip'),
      fs:      document.getElementById('fs'),
      out:     document.getElementById('out')
    };

    const app = new AsciiApp(ui.out, { fps: 30, invert: true });
    app.setOptions({});

    ui.start.onclick = () => app.start()
      .then(() => { ui.start.disabled = true; ui.stop.disabled = false; })
      .catch(e => alert('Камера недоступна: ' + e.message));

    ui.stop.onclick  = () => { app.stop(); ui.start.disabled = false; ui.stop.disabled = true; };
    ui.flip.onclick  = () => app.flip();
    wireFullscreen(ui.fs);
  </script>

  <noscript>
    <div class="card" style="margin:16px">
      Для работы приложения нужен JavaScript.
    </div>
  </noscript>
</body>
</html>
