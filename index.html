<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ASCII live · app</title>
  <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/better-vcr" />
  <link rel="stylesheet" href="styles.css?v=fit2" />
</head>
<body class="theme-dark">
  <div class="wrap" id="app">

  <!-- Верхняя панель -->
  <div class="toolbar">
    <button class="btn" id="flip">Развернуть</button>
    <button class="btn" id="toggle">Настройки</button>
    <button class="btn ghost" id="fs" aria-label="Fullscreen">Fullscreen</button>
  </div>

  <!-- Панель настроек -->
  <div class="panel" id="settings" hidden>
    <label>
      <span>Ширина</span>
      <input id="width" type="range" min="50" max="250" step="1" value="160" />
      <output id="width_val">160</output>
    </label>

    <label>
      <span>Контраст</span>
      <input id="contrast" type="range" min="0.4" max="2.2" step="0.01" value="1.15" />
      <output id="contrast_val">1.15</output>
    </label>

    <label>
      <span>Гамма</span>
      <input id="gamma" type="range" min="0.6" max="2.0" step="0.01" value="1.20" />
      <output id="gamma_val">1.20</output>
    </label>

    <label>
      <span>Цвет</span>
      <input id="fg" type="color" value="#8ac7ff" />
    </label>

    <label>
      <span>Фон</span>
      <input id="bg" type="color" value="#000000" />
    </label>

    <label>
      <span>FPS</span>
      <input id="fps" type="range" min="5" max="60" step="1" value="30" />
      <output id="fps_val">30</output>
    </label>

    <label>
      <span>Набор:</span>
      <select id="charset"></select>
    </label>

    <label class="check">
      <input id="invert" type="checkbox" checked />
      <span>Инверсия</span>
    </label>
  </div>

  <!-- Сцена вывода -->
  <div class="stage" id="stage">
    <pre id="out"></pre>
  </div>

  </div>

  <!-- Модульный скрипт приложения -->
  <script type="module">
    import { AsciiApp, CHARSETS, wireFullscreen } from './ascii.js';

    const $ = s => document.querySelector(s);

    // заполняем селект наборами из одного источника
    const select = $('#charset');
    const labels = {
      classic: 'Классический',
      digits: 'Цифры',
      letters: 'Буквы A–Z',
      allLetters: 'Все буквы a–z, A–Z',
      katakana: 'カタカナ',
      hiragana: 'ひらがな',
      dots: 'Точки',
      blocks: 'Блоки ░▒▓█'
    };
    Object.keys(CHARSETS).forEach(key => {
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = labels[key] || key;
      select.appendChild(opt);
    });
    select.value = 'classic';

    // создаём приложение
    const app = new AsciiApp($('#out'));

    function apply(){
      $('#width_val').textContent = $('#width').value;
      $('#contrast_val').textContent = (+$('#contrast').value).toFixed(2);
      $('#gamma_val').textContent = (+$('#gamma').value).toFixed(2);
      $('#fps_val').textContent = $('#fps').value;

      app.setOptions({
        widthChars: +$('#width').value,
        contrast: +$('#contrast').value,
        gamma: +$('#gamma').value,
        fps: +$('#fps').value,
        color: $('#fg').value,
        background: $('#bg').value,
        ramp: CHARSETS[$('#charset').value] || CHARSETS.classic,
        invert: $('#invert').checked
      });
    }
    ['width','contrast','gamma','fps','fg','bg','charset','invert'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('input', apply);
      el.addEventListener('change', apply);
    });
    apply();

    // кнопки
    $('#toggle').addEventListener('click', () => {
      const p = $('#settings');
      if (p.hasAttribute('hidden')) p.removeAttribute('hidden');
      else p.setAttribute('hidden','');
      // после показ/скрыть чуть подождём и попросим рефит
      setTimeout(app._refitFont.bind(app), 0);
    });
    $('#flip').addEventListener('click', () => app.flip());
    wireFullscreen($('#fs'), document.querySelector('.stage'));

    // стартуем
    app.start().catch(e => alert('Камера недоступна: ' + e.message));
  </script>
</body>
</html>
