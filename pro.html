<!doctype html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ASCII live · pro</title>
<link rel="stylesheet" href="styles.css?v=16">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="consent.js" defer></script>
</head>
<body class="theme-dark">
<div class="wrap">
  <div class="toolbar" id="toolbar">
    <button id="flip" class="btn">РАЗВЕРНУТЬ</button>
    <button id="fs"   class="btn ghost">FULLSCREEN</button>
    <a class="btn ghost" href="index.html">ПРИЛОЖЕНИЕ</a>
  </div>

  <div class="panel">
    <label>РАЗМЕР <input id="w" type="range" min="40" max="320" value="160"><span id="wv">160</span></label>
    <label>КОНТРАСТ <input id="contrast" type="range" min="50" max="220" value="115"><span id="cv">1.15</span></label>
    <label>ГАММА <input id="gamma" type="range" min="60" max="180" value="120"><span id="gv">1.20</span></label>
    <label>ТЕКСТ <input id="fg" type="color" value="#8ac7ff"></label>
    <label>ФОН <input id="bg" type="color" value="#000000"></label>
    <label>FPS <input id="fps" type="range" min="5" max="60" value="30"><span id="fpsv">30</span></label>
    <label>НАБОР:
      <select id="preset">
        <option value="classic">CLASSIC</option>
        <option value="digits">NUMBERS</option>
        <option value="letters">LETTERS</option>
        <option value="dots">DOTS (ASCII)</option>
        <option value="blocks">░▒▓█</option>
        <option value="custom">CUSTOM</option>
      </select>
      <input id="ramp" type="text" placeholder="свой набор символов" style="width:240px;display:none">
    </label>
    <label><input id="invert" type="checkbox" checked> ИНВЕРСИЯ</label>
  </div>

  <div class="stage"><pre id="out" class="ascii-surface"></pre></div>
</div>

<div class="modal" id="consent" hidden>
  <div class="card">
    <h3>Доступ к камере</h3>
    <p>Видеопоток обрабатывается локально на вашем устройстве.</p>
    <button id="agree" class="btn" type="button">Ок, понимаю</button>
  </div>
</div>

<script type="module">
import { AsciiApp, wireFullscreen, buildRamp } from './ascii.js';
if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

const $ = id => document.getElementById(id);
const ui = { out:$('out'), flip:$('flip'), fs:$('fs'), toolbar:$('toolbar') };
const app = new AsciiApp(ui.out);

function presetCandidates(name){
  switch(name){
    case 'digits':  return ' 1234567890';
    case 'letters': return ' iljtfrxnuvczsyoeapdhgbqkmwILJTFRXNVCAZSEYOAPDHGBQKMW';
    case 'dots':    return " .`:-*+ox%#@";
    case 'blocks':  return ' ░▒▓█';
    case 'classic':
    default:        return " .'`\",:;Il!i><~+_-?][}{1)(|\\/*tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";
  }
}
async function rampFor(name, customRaw){
  if (name === 'custom') {
    const cand = normalize(customRaw || '');
    return await buildRamp({ candidates:cand, fontFamily:app.fontFamily, fontSize:app.fontSize, filterWidth:true }) || cand;
  }
  const cand = presetCandidates(name);
  return await buildRamp({ candidates:cand, fontFamily:app.fontFamily, fontSize:app.fontSize, filterWidth:true }) || cand;
}
function normalize(raw){
  const stripped = (raw||'').replace(/\r?\n/g,'');
  const unique = Array.from(new Set(Array.from(stripped)));
  if (!unique.includes(' ')) unique.unshift(' ');
  return unique.filter(ch => ch >= ' ' && ch !== '\t').join('');
}
async function apply(){
  $('wv').textContent = $('w').value;
  $('cv').textContent = (+$('contrast').value/100).toFixed(2);
  $('gv').textContent = (+$('gamma').value/100).toFixed(2);
  $('fpsv').textContent = $('fps').value;

  if ($('preset').value === 'custom') $('ramp').style.display = 'inline-block';
  else $('ramp').style.display = 'none';

  const ramp = await rampFor($('preset').value, $('ramp').value);

  app.setOptions({
    widthChars:+$('w').value,
    contrast:+$('contrast').value/100,
    gamma:+$('gamma').value/100,
    color:$('fg').value,
    background:$('bg').value,
    fps:+$('fps').value,
    ramp,
    invert:$('invert').checked
  });
}
['w','contrast','gamma','fg','bg','fps','preset','ramp','invert'].forEach(id=>{
  $(id).addEventListener('input', apply);
  $(id).addEventListener('change', apply);
});
apply();

function startNow(){ app.start().catch(e=>alert('Камера недоступна: ' + e.message)); }
if (localStorage.getItem('consent-ok') === '1') startNow();
else document.addEventListener('consent-ready', startNow, { once:true });

ui.flip.onclick = () => app.flip();
wireFullscreen(ui.fs, ui.toolbar);
</script>
</body></html>
