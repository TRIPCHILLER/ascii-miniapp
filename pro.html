<!doctype html><html><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASCII live · pro</title>
<link rel="stylesheet" href="styles.css">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="consent.js" defer></script>
</head>
<body class="theme-dark">
<div class="wrap">
  <div class="toolbar" id="toolbar">
    <button id="flip" class="btn">Фронт/Тыл</button>
    <a class="btn ghost" href="index.html">Приложение</a>
  </div>

  <div class="panel">
    <label>Ширина <input id="w" type="range" min="40" max="240" value="140"><span id="wv">140</span></label>
    <label>Контраст <input id="contrast" type="range" min="50" max="200" value="115"><span id="cv">1.15</span></label>
    <label>Гамма <input id="gamma" type="range" min="60" max="180" value="120"><span id="gv">1.20</span></label>
    <label>Цвет <input id="fg" type="color" value="#8ac7ff"></label>
    <label>Фон <input id="bg" type="color" value="#000000"></label>
    <label>FPS <input id="fps" type="range" min="5" max="60" value="30"><span id="fpsv">30</span></label>
    <label>Набор <input id="ramp" type="text" value=" .'`&quot;,:;Il!i~+_-?][}{1tfjrxnuvczXYUJCLQ0089@#"></label>
    <label><input id="invert" type="checkbox" checked> Инверсия</label>
  </div>

  <div class="stage"><pre id="out"></pre></div>
</div>

<!-- одноразовый дисклеймер для прямого захода в настройки -->
<div class="modal" id="consent" hidden>
  <div class="card">
    <h3>Доступ к камере</h3>
    <p>Видеопоток обрабатывается локально на вашем устройстве.</p>
    <button id="agree" class="btn" type="button">Ок, понимаю</button>
  </div>
</div>

<script type="module">
import { AsciiApp } from './ascii.js';
if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

const $ = id => document.getElementById(id);
const ui = { out:$('out'), flip:$('flip') };
const app = new AsciiApp(ui.out);

// Применение настроек в реальном времени
function apply(){
  $('wv').textContent = $('w').value;
  $('cv').textContent = (+$('contrast').value/100).toFixed(2);
  $('gv').textContent = (+$('gamma').value/100).toFixed(2);
  $('fpsv').textContent = $('fps').value;
  app.setOptions({
    widthChars:+$('w').value,
    contrast:+$('contrast').value/100,
    gamma:+$('gamma').value/100,
    color:$('fg').value,
    background:$('bg').value,
    fps:+$('fps').value,
    ramp:$('ramp').value,
    invert:$('invert').checked
  });
}
['w','contrast','gamma','fg','bg','fps','ramp','invert'].forEach(id=>{
  $(id).addEventListener('input', apply);
});
apply();

// Стартуем КАМЕРУ:
// - если уже дано согласие (localStorage) — сразу
// - если нет — после события от consent.js ('consent-ready')
function startNow(){ app.start().catch(e=>alert('Камера недоступна: '+e.message)); }
if (localStorage.getItem('consent-ok') === '1') startNow();
else document.addEventListener('consent-ready', startNow, {once:true});

ui.flip.onclick = () => app.flip();
</script>
</body></html>
